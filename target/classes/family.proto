syntax = "proto3";

package family;

option java_multiple_files = true;
option java_package = "com.example.family";
option java_outer_classname = "FamilyProto";

// Aile üyeleri (nodelar) arasındaki gRPC haberleşmesi
// Lider ve üyeler, istemciden gelen text tabanlı HaToKuSe mesajlarını
// kendi aralarında protobuf nesneleri ile taşırlar.

service FamilyReplicationService {
  // Lider, gelen SET isteğini hata toleransına göre üyelere bu RPC ile çoğaltır.
  rpc ReplicateMessage (ReplicateMessageRequest) returns (ReplicateMessageResponse);

  // Lider, GET isteği geldiğinde, ilgili mesajı tutan üyelerden birinden bu RPC ile çeker.
  rpc FetchMessage (FetchMessageRequest) returns (FetchMessageResponse);

  // Üyelerin aileye dinamik katılımı için basit kayıt RPC'si.
  rpc RegisterNode (RegisterNodeRequest) returns (RegisterNodeResponse);
}

// Ortak mesaj tanımı
message StoredMessage {
  string id = 1;       // message_id
  string body = 2;     // message içeriği
}

// --- Replication ---

message ReplicateMessageRequest {
  StoredMessage message = 1;
}

message ReplicateMessageResponse {
  bool success = 1;
  string error = 2;
}

// --- Fetch ---

message FetchMessageRequest {
  string id = 1;
}

message FetchMessageResponse {
  bool found = 1;
  StoredMessage message = 2;
}

// --- Dynamic membership ---

message RegisterNodeRequest {
  string nodeId = 1;
  string host = 2;
  int32 port = 3;
}

message RegisterNodeResponse {
  bool accepted = 1;
  string error = 2;
}

